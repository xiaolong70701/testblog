{
  "hash": "14008c282c8337ed4c19966c345da6c6",
  "result": {
    "markdown": "---\ntitle: \"Como usar senhas sem escreve-las nos scripts\"\nsubtitle: \"Usando senhas, tokens e keys no código em R de forma segura.\"\nauthor: \"Beatriz Milz\"\ndate: \"2022-09-13\"\ncategories: [\"Tutorial\"]\nimage: \"logo-featured.jpg\"\ntoc: true\ndraft: false\n---\n\n<a href=\"../pt/index.qmd\"> <button type=\"button\" class=\"btn btn-primary\">Português</button></a>\n\n\n## Introdução\n\nAs vezes precisamos usar alguma senha/Token/Key para rodar um código, como por exemplo ao usar uma API que solicita autenticação. Mas isso significa que devemos escrever a senha no próprio script `.R`, por exemplo?\n\n**Não!** Inclusive isso é um pouco perigoso. Imagina armazenar a senha para um serviço pago, esquecer e disponibilizar o script no GitHub? É receita para receber uma notificação do cartão de crédito cobrando algo que nem usamos... É, já ouvi casos assim!\n\nEntão neste post trago algumas dicas para evitar salvar as senhas nos scripts quando estiver programando.\n\n## Variáveis de ambiente\n\nUma forma de fazer isso é com as variáveis de ambiente (*environment variables*). Não vou detalhar o conceito de ambientes mas deixei um link nas referências, ao final do post.\n\nSimplificando, as variáveis de ambientes são objetos que são carregados ao iniciar a sessão do R. Então eles ficarão disponíveis para uso, apesar de não aparecer no painel *Environment* do RStudio.\n\nUma forma de saber quais são as nossas variáveis de ambiente é usando a função `Sys.getenv()` sem argumentos. Atenção, várias variáveis de configuração irão aparecer no output e não recomendo alterá-las.\n\n::: {.callout-caution collapse=\"true\"}\n## Expanda para ver o output da função `Sys.getenv()`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSys.getenv()\n```\n:::\n\n\n    __CF_USER_TEXT_ENCODING\n                     0x1F5:0x0:0x47\n    __CFBundleIdentifier\n                     org.rstudio.RStudio\n    CLICOLOR_FORCE   1\n    COMMAND_MODE     unix2003\n    DISPLAY          :0\n    EDITOR           vi\n    GIT_ASKPASS      rpostback-askpass\n    GITHUB_PAT       REMOVI-DO-OUTPUT\n    HOME             /Users/beatrizmilz\n    LANG             en_US.UTF-8\n    LaunchInstanceID\n                     CE64F966-8CED-4F36-98D6-0965383D7CE7\n    LC_CTYPE         en_US.UTF-8\n    LD_LIBRARY_PATH\n                     \n    LN_S             ln -s\n    LOGNAME          beatrizmilz\n    MAKE             make\n    MPLENGINE        tkAgg\n    PAGER            /usr/bin/less\n    PATH             /opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/Users/beatrizmilz/Applications/quarto/bin:/Library/TeX/texbin:/usr/texbin:/Applications/RStudio.app/Contents/MacOS:/Users/beatrizmilz/Library/TinyTeX/bin/universal-darwin\n    PDF_TABLES       REMOVI-DO-OUTPUT\n    PYTHONIOENCODING\n                     utf-8\n    R_BROWSER        /usr/bin/open\n    R_BZIPCMD        /usr/bin/bzip2\n    R_CLI_HAS_HYPERLINK_IDE_HELP\n                     true\n    R_CLI_HAS_HYPERLINK_IDE_RUN\n                     true\n    R_CLI_HAS_HYPERLINK_IDE_VIGNETTE\n                     true\n    R_DOC_DIR        /Library/Frameworks/R.framework/Resources/doc\n    R_GZIPCMD        /usr/bin/gzip\n    R_HOME           /Library/Frameworks/R.framework/Resources\n    R_INCLUDE_DIR    /Library/Frameworks/R.framework/Resources/include\n    R_LIBS_SITE      /Library/Frameworks/R.framework/Resources/site-library\n    R_LIBS_USER      /Users/beatrizmilz/Library/R/arm64/4.2/library\n    R_PAPERSIZE      a4\n    R_PDFVIEWER      /usr/bin/open\n    R_PLATFORM       aarch64-apple-darwin20\n    R_PRINTCMD       lpr\n    R_QPDF           /Library/Frameworks/R.framework/Resources/bin/qpdf\n    R_RD4PDF         times,inconsolata,hyper\n    R_SESSION_TMPDIR\n                     /var/folders/st/0346cszj61928zc133bfr8dm0000gn/T//RtmptDuZaS\n    R_SHARE_DIR      /Library/Frameworks/R.framework/Resources/share\n    R_STRIP_SHARED_LIB\n                     strip -x\n    R_STRIP_STATIC_LIB\n                     strip -S\n    R_SYSTEM_ABI     macos,gcc,gxx,gfortran,gfortran\n    R_TEXI2DVICMD    /opt/R/arm64/bin/texi2dvi\n    R_UNZIPCMD       /usr/bin/unzip\n    R_ZIPCMD         /usr/bin/zip\n    RMARKDOWN_MATHJAX_PATH\n                     /Applications/RStudio.app/Contents/Resources/resources/mathjax-27\n    RS_PPM_FD_READ   71\n    RS_PPM_FD_WRITE\n                     102\n    RS_RPOSTBACK_PATH\n                     /Applications/RStudio.app/Contents/rpostback\n    RS_SHARED_SECRET\n                     aae3fa0b-2378-4433-91b1-23ef6bfbcd3a\n    RSTUDIO          1\n    RSTUDIO_CLI_HYPERLINKS\n                     true\n    RSTUDIO_CONSOLE_COLOR\n                     256\n    RSTUDIO_CONSOLE_WIDTH\n                     59\n    RSTUDIO_FALLBACK_LIBRARY_PATH\n                     /var/folders/st/0346cszj61928zc133bfr8dm0000gn/T/rstudio-fallback-library-path-LeirDE\n    RSTUDIO_PANDOC   /Applications/RStudio.app/Contents/MacOS/quarto/bin/tools\n    RSTUDIO_PROGRAM_MODE\n                     desktop\n    RSTUDIO_SESSION_PID\n                     99417\n    RSTUDIO_SESSION_PORT\n                     50432\n    RSTUDIO_USER_IDENTITY\n                     beatrizmilz\n    RSTUDIO_WINUTILS\n                     bin/winutils\n    SECURITYSESSIONID\n                     186b0\n    SED              /usr/bin/sed\n    SHELL            /bin/zsh\n    SSH_ASKPASS      rpostback-askpass\n    SSH_AUTH_SOCK    /private/tmp/com.apple.launchd.rgFEwrNe29/Listeners\n    TAR              /usr/bin/tar\n    TERM             xterm-256color\n    TMPDIR           /var/folders/st/0346cszj61928zc133bfr8dm0000gn/T/\n    TZDIR            /var/db/timezone/zoneinfo\n    USER             beatrizmilz\n    XPC_FLAGS        0x0\n    XPC_SERVICE_NAME\n                     0\n:::\n\nA função `Sys.setenv()` permite que você salve a senha/token nas variáveis de ambiente. Cuidado, rode essa etapa no console e não salve no script (pois justamente queremos não armazenar as senhas no script, certo?).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSys.setenv(MINHA_SENHA = 1234)\n```\n:::\n\n\nPara buscar o valor salvo na variável, pode usar a função `Sys.getenv()`. Essa função podemos usar no nosso script sem problemas!\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSys.getenv(\"MINHA_SENHA\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"1234\"\n```\n:::\n:::\n\n\n## Indo além com a ajuda do usethis\n\nAs variáveis de ambiente podem ser vinculadas ao `.Rproj` ativo, ou ao usuário do computador. Elas ficam salvas no arquivo `.Renviron`. Para abrir o arquivo e ver as variáveis de ambiente salvas, você pode usar a função `usethis::edit_r_environ()`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Abre as variáveis de ambiente para o usuário do computador\nusethis::edit_r_environ(scope = \"user\")\n#> • Modify '/Users/beatrizmilz/.Renviron'\n#> • Restart R for changes to take effect\n\n# Abre as variáveis de ambiente para o projeto ativo\nusethis::edit_r_environ(scope = \"project\")\n#> ✔ Setting active project to '/Users/beatrizmilz/Documents/GitHub/blog-en'\n#> • Modify '.Renviron'\n#> • Restart R for changes to take effect\n```\n:::\n\n\nO padrão para armazenar variáveis neste arquivo é:\n\n    NOME_VAR='SENHAAQUI12345'\n\n**Atenção!** Depois de alterar o arquivo `.Renviron`, é necessário reiniciar o R para que as mudanças sejam consideradas. Isso porque esse arquivo é carregado ao iniciar o R.\n\n**Atenção 2**: Caso você use um arquivo `.Renviron` vinculado ao seu projeto `.Rproj`, cuidado ao subir esse arquivo para o GitHub, é perigoso pois pessoas poderão ver suas senhas. Se o seu repositório for público, é essencial que você adicione ele no `.gitignore`, assim ele será ignorado pelo Git. A função `usethis::use_git_ignore()` pode nos ajudar nisso:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nusethis::use_git_ignore(\".Renviron\")\n#> ✔ Adding '.Renviron' to '.gitignore'\n```\n:::\n\n\n## Solicitar a senha\n\nE quando queremos que a pessoa usuária possa sempre escrever a senha? Existe uma função para isso: `rstudioapi::askForPassword()`. Podemos inclusive escrever a frase que será mostrada ao perguntar a senha. A senha digitada será retornada como um texto, e podemos salvar em um objeto para utilizar posteriormente no que for necessário.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsenha_informada <- rstudioapi::askForPassword(\n  \"Escreva sua senha por favor!\"\n)\n```\n:::\n\n\n![Pop up feito pela função askForPassword.](askforpassword.png){fig-align=\"center\" width=\"90%\"}\n\n## GitHub Actions\n\nE quando precisamos usar senhas em códigos rodados com GitHub Actions (GHA)? Se você não conhece nada sobre GHA, [eu tenho alguns posts sobre isso](series-gha.qmd)!\n\nQuando estamos usando GHA, podemos adicionar senhas na sessão SECRETS do GitHub. Assim ninguém (exceto você, quando cria um SECRETS), verá a senha/credenciais.\n\nIsso fica nas configurações do repositório, e o link usa esse padrão:\n\n    https://github.com/SEU-USUARIO/SEU-REPOSITORIO/settings/secrets/actions\n\nExemplo de um repositório privado meu:\n\n![Print screen da página de secrets.](githubsecrets.png){fig-align=\"center\" width=\"90%\"}\n\nTambém é preciso adaptar o código do action para buscar essa variável no Secrets. Exemplo de código:\n\n          - name: Execute Script\n            env:\n              GITHUB_PAT: ${{ secrets.GITHUB_PAT }}\n              NOME_VAR: ${{ secrets.NOME_VAR }}\n            run: |\n              Rscript \"seu_script.R\"\n\nCom isso é possível acessar essas variáveis com senha, no script usando a função `Sys.getenv('NOME_VAR')` que mostrei acima.\n\n## Mais camadas de segurança\n\nPara mais camadas de segurança, recomendo a leitura da [documentação do pacote httr2, no trecho sobre *Secret management*](https://httr2.r-lib.org/articles/wrapping-apis.html#secret-management). Nesse trecho, além de apresentar a opção utilizando a função `usethis::edit_r_environ()`, também é apresentado as funções `httr2::secret_encrypt()` e `htt2::secret_decrypt()`.\n\nEu ainda não testei essas funções pois o pacote `httr2` é bem recente. Segundo o autor do pacote (o [Hadley Wickham](https://hadley.nz/)), com essas funções é possível usar criptografia para lidar com as senhas/tokens.\n\n## Conclusão\n\nEspero que este post seja interessante para você, e que as suas senhas estejam sempre protegidas! Bons estudos e até a próxima!\n\n## Referências\n\n-   [Environments/Ambientes - Hands-On Programming with R](https://rstudio-education.github.io/hopr/environments.html#assignment)\n\n-   [Secret management - Documentação do pacote httr2](https://httr2.r-lib.org/articles/wrapping-apis.html#secret-management)\n\n## Agradecimentos\n\n-   Julio Trecenti, pela leitura prévia e sugestões feitas no texto.\n\n-   Tive a ideia de escrever esse post ao responder uma pergunta feita pela aluna Mari Ribeiro, em um curso da Curso-R. Obrigada Mari!\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}